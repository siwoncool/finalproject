<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <meta name="author" content="기섭">
    <meta name="date" content="">
    <meta name="description" content="">

    <title></title>

    <!-- Favicon -->
    <link href="img/favicon.ico" rel="shortcut icon"/>

    <!-- Google font -->
    <link href="https://fonts.googleapis.com/css?family=Montserrat:300,300i,400,400i,500,500i,600,600i,700,700i&display=swap" rel="stylesheet">

    <link href="https://fonts.googleapis.com/css?family=Quicksand:300,400,500,700" rel="stylesheet">

    <!-- Animate.css -->
    <link rel="stylesheet" href="css/main/animate.css">
    <!-- Icomoon Icon Fonts-->
    <link rel="stylesheet" href="css/main/icomoon.css">
    <!-- Bootstrap  -->
    <link rel="stylesheet" href="css/main/bootstrap.css">
    <!-- Flexslider  -->
    <link rel="stylesheet" href="css/main/flexslider.css">
    <!-- Flaticons  -->
    <link rel="stylesheet" href="fonts/flaticon/font/flaticon.css">
    <!-- Owl Carousel -->
    <link rel="stylesheet" href="css/main/owl.carousel.min.css">
    <link rel="stylesheet" href="css/main/owl.theme.default.min.css">
    <!-- Theme style  -->
    <link rel="stylesheet" href="css/main/style.css">


    <link rel="stylesheet" type="text/css" href="https://maxcdn.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css">

    <!-- script
    ================================================== -->
    <script src="js/modernizr.js"></script>

    <!-- Modernizr JS -->
    <script src="js/modernizr-2.6.2.min.js"></script>
    <!-- FOR IE9 below -->
    <!--[if lt IE 9]>
    <script src="js/respond.min.js"></script>
    <![endif]-->

    <!-- Stylesheets -->
    <link rel="stylesheet" href="css/music/bootstrap.min.css"/>
    <link rel="stylesheet" href="css/music/font-awesome.min.css"/>
    <link rel="stylesheet" href="css/music/owl.carousel.min.css"/>
    <link rel="stylesheet" href="css/music/slicknav.min.css"/>

    <!-- Main Stylesheets -->
    <link rel="stylesheet" href="css/music/style.css"/>
    <link rel="stylesheet" href="css/header.css">


    <!--[if lt IE 9]>
    <script src="https://oss.maxcdn.com/html5shiv/3.7.2/html5shiv.min.js"></script>
    <script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
    <![endif]-->

</head>
<style th:replace="mouse.html :: style"></style>
<body>
<!-- Page Preloder -->
<div id="preloder">
    <div class="loader"></div>
</div>

<div id="colorlib-page">
    <a href="#" class="js-colorlib-nav-toggle colorlib-nav-toggle"><i></i></a>

    <header th:replace="sider.html :: header"></header>

    <div id="colorlib-main">

<!-- Player section -->
<section class="player-section set-bg" data-setbg="img/player-bg.jpg">
    <div class="player-box">
        <div class="tarck-thumb-warp">
            <div class="tarck-thumb">
                <!--이미지 넣기-->
                <img th:src="@{PSW/bestimg/{img}(img=${bview.boaBestImg})}" alt="">
            </div>
        </div>
        <div class="wave-player-warp">
            <div class="row">
                <div class="col-lg-8">
                    <div class="wave-player-info">
                        <h2>[[${bview.boaTitle}]]</h2>
                        <p>[[${bview.boaHit}]]</p>

                    </div>
                </div>
                <div class="col-lg-4">
                    <div class="songs-links">
                        <a href=""><img src="img/icons/p-1.png" alt=""></a>
                        <!--파일 다운로드-->
                        <a th:href="@{download(boaFileName = ${bview.boaFileName})}"><img src="img/icons/p-2.png" alt=""></a>
                        <a href=""><img src="img/icons/p-3.png" alt=""></a>
                    </div>
                </div>
            </div>
            <div id="wavePlayer" class="clierfix">
                <div id="audiowave" data-waveurl="music-files/8.mp3"></div>
                <div id="currentTime"></div>
                <div id="clipTime"></div>
                <!-- Player Controls -->
                <!-- song -->
                <div class="song-item">
                    <div class="row">
                        <div class="col-xl-7 col-lg-12 col-md-7">
                            <div class="single_player_container">
                                <div class="single_player">
                                    <div class="jp-jplayer jplayer" data-ancestor=".jp_container_1" th:data-url="@{PSW/mp3/{boaFileName}(boaFileName=${bview.boaFileName})}"></div>
                                    <div class="jp-audio jp_container_1" role="application" aria-label="media player">
                                        <div class="jp-gui jp-interface">

                                            <!-- Player Controls -->
                                            <div class="player_controls_box">
                                                <button class="jp-prev player_button" tabindex="0"></button>
                                                <button class="jp-play player_button" tabindex="0"></button>
                                                <button class="jp-next player_button" tabindex="0"></button>
                                                <button class="jp-stop player_button" tabindex="0"></button>
                                            </div>
                                            <!-- Progress Bar -->
                                            <div class="player_bars">
                                                <div class="jp-progress">
                                                    <div class="jp-seek-bar">
                                                        <div>
                                                            <div class="jp-play-bar"><div class="jp-current-time" role="timer" aria-label="time">0:00</div></div>
                                                        </div>
                                                    </div>
                                                </div>
                                                <div class="jp-duration ml-auto" role="timer" aria-label="duration">00:00</div>
                                            </div>
                                        </div>
                                        <div class="jp-no-solution">
                                            <span>Update Required</span>
                                            To play the media you will need to either update your browser to a recent version or update your <a href="http://get.adobe.com/flashplayer/" target="_blank">Flash plugin</a>
                                        </div>

                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>


            </div>
        </div>
    </div>
</section>


<!-- Player section end -->

<!-- Songs details section -->
<section class="songs-details-section">
    <div class="container-fluid">
        <div class="row">

            <div class="col-lg-9">
                <div class="row">
                    <div class="col-lg-6">
                        <div class="song-details-box">
                            <h3>About the Artist</h3>
                            <div class="artist-details">
                                <img th:src="@{fish/img/memProfileImg/img(img=${bview.memProfileName})}" alt="">
                                <div class="ad-text">
                                    <h5>[[${bview.memName}]]</h5>
                                    <span>[[${bview.memGrade}]]</span>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="col-lg-6">
                        <div class="song-details-box">
                            <!--파일 다운로드-->
                            <!--<block th:if="${bview.boaFileName} ne 'null'">
                                <a th:href="@{download(boaFileName = ${bview.boaFileName})}">[[${bview.boaFileName}]]</a>
                            </block>-->
                            <block th:if="${session.login ne null && session.login.memCode eq bview.boaMemcode}">
                                <button onclick="bModify()">수정하기</button>
                                <button onclick="bDelete()">삭제하기</button>
                            </block>
                            <div id="cmtArea"></div>
                            <div>
                                <input type="hidden" th:value="${bview.boaCode}" id="cbNum"/>
                                <block th:if="${session.login ne null}">
                                    <input type="hidden" th:value="${session.login.getMemCode()}" id="cmtWriter"/>
                                    <input type="hidden" id="gmemCode" th:value="${session.login.getMemCode()}">
                                </block>

                                <textarea rows="3" cols="30" id="cmtContent" onfocus="checkLogin()"></textarea>
                                <button onclick="cmtWrite()">댓글 입력</button>
                            </div>

                        </div>
                    </div>
                </div>
            </div>
            <div class="col-lg-3">
                <div class="song-details-box">
                    <h3>내용</h3>
                    <input type="hidden" id="orboaContent" th:value="${bview.boaContent}">
                    <li  id="boaContent"></li>

                    <a href="#"
                       class="book-a-table-btn scrollto d-none d-lg-flex"
                       onclick="DRA005();" id="likebtn"
                    ><span>좋아요 </span><span id="like"></span></a>
                </div>
            </div>

        </div>
    </div>
</section>
<!-- Songs details section -->
        <input type="hidden" id="memCode" th:value="${bview.boaMemcode}">
        <input type="hidden" id="boaCode" th:value="${bview.boaCode}">



</div>
</div>

<!--====== Javascripts & Jquery ======-->
<script src="js/music/jquery-3.2.1.min.js"></script>
<script src="js/music/bootstrap.min.js"></script>
<script src="js/music/jquery.slicknav.min.js"></script>
<script src="js/music/owl.carousel.min.js"></script>
<script src="js/music/mixitup.min.js"></script>
<script src="js/music/main.js"></script>

<!-- Audio Player and Initialization -->
<script src="js/music/jquery.jplayer.min.js"></script>
<script src="js/music/jplayerInit.js"></script>

<!-- jQuery -->
<script src="js/jquery.min.js"></script>
<!-- jQuery Easing -->
<script src="js/jquery.easing.1.3.js"></script>
<!-- Bootstrap -->
<script src="js/bootstrap.min.js"></script>
<!-- Waypoints -->
<script src="js/jquery.waypoints.min.js"></script>
<!-- Flexslider -->
<script src="js/jquery.flexslider-min.js"></script>
<!-- Sticky Kit -->
<script src="js/sticky-kit.min.js"></script>
<!-- Owl carousel -->
<script src="js/owl.carousel.min.js"></script>
<!-- Counters -->
<script src="js/jquery.countTo.js"></script>


<!-- MAIN JS -->
<script src="js/main.js"></script>

</body>

<script src="https://code.jquery.com/jquery-3.6.3.js" integrity="sha256-nQLuAZGRRcILA+6dMBOvcRh5Pe310sBpanc6+QBmyVM=" crossorigin="anonymous"></script>
<script>
    let orboaContent = $('#orboaContent').val();
    document.getElementById("boaContent").innerHTML = orboaContent;

    let boaMemcode = $('#memCode').val();
    let boaCode = $('#boaCode').val();
    console.log("boaMemCode = "+boaMemcode);
    console.log("boaCode = "+boaCode);

    let click = 0;
    $.ajax({
        type: "POST",
        url: "DRA005",
        data: {
            "boaMemcode": boaMemcode,
            "boaCode": boaCode,
            "click": click
        },
        dataType: "json",
        success: function (result) {
            changeLike(result);
        },
        error: function () {
            alert("맨처음 DRA005함수 통신실패!");
        }
    });

    function DRA005() {
        click = 1;

        $.ajax({
            type: "POST",
            url: "DRA005",
            data: {
                "boaMemcode": boaMemcode,
                "boaCode": boaCode,
                "click": click
            },
            dataType: "json",
            success: function (result) {
                changeLike(result);
            },
            error: function () {
                alert("DRA005함수 통신실패!");
            }
        });
    }
    function changeLike(result) {
        let like = document.getElementById("like");
        let likebtn = document.getElementById("likebtn");

        // 좋아요 갯수 표시
        like.innerHTML = result.MLCount;

        // 좋아요 눌렀나 안눌렀나? css 변화 1이면 누른거
        if (result.MLDo  == 1) {
            likebtn.style.background = '#ff0000';
            likebtn.style.borderColor = '#ff0000';

            likebtn.addEventListener('mouseover', function () {
                likebtn.style.background = 'black';
                likebtn.style.borderColor = 'white';

            });
            likebtn.addEventListener('mouseout', function () {
                likebtn.style.background = '#ff0000';
                likebtn.style.borderColor = '#ff0000';

            });
        } else {
            likebtn.style.background = 'none';
            likebtn.style.borderColor = 'white';

            likebtn.addEventListener('mouseover', function () {
                likebtn.style.background = '#ff0000';
                likebtn.style.borderColor = '#ff0000';

            });
            likebtn.addEventListener('mouseout', function () {
                likebtn.style.background = 'none';
                likebtn.style.borderColor = 'white';

            });
        }
    }

    DRA006();
    function DRA006(){
        $.ajax({
            type : "POST",
            url : "DRA006",
            data : {
                "boaCode" : boaCode
            },
            dataType : "json",
            success : function(list){

                commentList(list);
            },
            error : function(){
                alert("댓글 불러오기 통신 실패!");
            }
        });
    }


    // 댓글리스트 불러오기
    function commentList(list){
        let memCode = $('#memCode').val();
        let gmemCode = $("#gmemCode").val();
        let output = "";
        output += "<table>";
        output += "<tr>";
        output += "<th>작성자</th>";
        output += "<th>내용</th>";
        output += "<th>작성일</th>";
        output += "<th>수정</th>";
        output += "<th>삭제</th>";
        output += "</tr>";

        let check = false;

        for(let i in list){
            console.log("list[i].coModi?? "+list[i].coModi)
            if(list[i].coModi==1){
                output += "<tr>";
                output += "<td>"+ list[i].memName +"</td>";
                output += "<td><span id='cmtModiContent"+i+"'>"+ list[i].coMent +"---수정됨</span></td>";
                output += "<td>"+ list[i].comDate +"</td>";
            }else{
                output += "<tr>";
                output += "<td>"+ list[i].memName +"</td>";
                output += "<td><span id='cmtModiContent"+i+"'>"+ list[i].coMent +"</span></td>";
                output += "<td>"+ list[i].comDate +"</td>";

            }


            console.log("memCODE????!!?!?"+memCode);
            console.log("list[i].comMencode????!!?!?"+list[i].comMemcode);
            if(gmemCode == list[i].comMemcode || memCode == 1){
                output += "<td><button onclick=\"DRA006_2("+ list[i].comCode +", "+list[i].ComBoaCode+", 'cmtModiContent"+i+"'"+")\">수정</button></td>";
                output += "<td><button onclick=\"DRA006_3("+ list[i].comCode +", "+list[i].ComBoaCode+")\">삭제</button></td>";
            } else {
                output += "<td></td><td></td>";
            }

            output += "</tr>";
        }

        document.getElementById("cmtArea").innerHTML = output;

    }
    function DRA006_3(comCode, ComBoaCode){
        $.ajax({
            type : "POST",
            url : "DRA006_3",
            data : {
                "comCode" : comCode,
                "ComBoaCode" : ComBoaCode
            },
            dataType : "json",
            success : function(list){
                commentList(list);
            },
            error : function(){
                alert("댓글 삭제 통신 실패!");
            }
        });
    }
    // 댓글작성하기ajax
    function cmtWrite(){
        let cmtWriter = document.getElementById("cmtWriter").value;
        let cmtContent = $("#cmtContent").val();
        let cbNum = $("#cbNum").val();

        $.ajax({
            type : "POST",
            url : "DRA006_1",
            data : {
                "ComBoaCode" : cbNum,
                "comMemcode" : cmtWriter,
                "coMent" : cmtContent
            },
            dataType : "json",
            success : function(list){
                commentList(list);
                $("#cmtContent").val("");
            },
            error : function(){
                alert('댓글 작성 통신 실패!');
            }
        });
    }
    // 수정버튼 눌렀을떄
    function DRA006_2(comCode, ComBoaCode, tagid){
        console.log("comCode : " + comCode + " , ComBoaCode : " + ComBoaCode);
        console.log("tagid : "+ tagid);

        $("#"+tagid).html("<input type='text' id='cContent'/><input type='button' value='확인' onclick='cmtModify("+comCode+", "+ComBoaCode+")'/>");
    }
    // 수정댓글 내용 작성 후 확인 버튼 눌렀을떄
    function cmtModify(comCode, ComBoaCode){
        console.log("comCode : " + comCode + " , ComBoaCode : " + ComBoaCode);

        let cmtContent = $("#cContent").val();

        $.ajax({
            type : "POST",
            url : "DRA006_2",
            data : {
                "comCode" : comCode,
                "ComBoaCode" : ComBoaCode,
                "coMent" : cmtContent
            },
            dataType : "json",
            success : function(list){
                commentList(list);
            },
            error : function(){
                alert("댓글 수정 통신 실패!");
            }
        });

    }

    // 댓글 입력시 로그인여부
    function checkLogin(){
        let gmemCode = $("#gmemCode").val();
        if(gmemCode == null){
            $("#cmtContent").blur();
            alert('로그인 후 사용하세요.');
            location.href="index";
        }
    }
    // 게시글 수정페이지 이동
    function bModify(){
        location.href="DRA009?boaCode="+boaCode;
    }
    function bDelete(){
        location.href="DRA0010?boaCode="+boaCode;
    }
</script>
<script th:if="${session.login ne null}">

    console.log("세션로그인?"+boaMemcode);

    $.ajax({
        type: "POST",
        url: "DRA011",
        data: {
            "bhMemCode": boaMemcode,
            "bhBoaCode": boaCode,

        },
        dataType: "text",
        success: function (text) {
            if(text=="OK"){
                console.log("히스토리 삽입성공!");
            }else{
                console.log("히스토리 삽입실패!");
            }

        },
        error: function () {
            alert("맨처음 DRA011 통신실패!");
        }
    });


</script>

</html>